## 计算机网络

### 一、网络层

1. Mac地址，ip地址

2. ARP协议(address resolution):源主机自查ARP缓存->不存在则广播ARP请求包->目的主机应答并各自更新缓存

3. RARP协议：MAC设备向RARP服务器请求IP地址。

4. NAT协议，NIC、ISP；(netword address translation)(network information center、netword interface card)(internet service)，NAT路由器为私网主机执行端口转换达到辨识度。

   > 缺陷：内外部没有直接连接、转换表的生成与转换有性能开销、NAT路由器重启所有TCP连接重置。
   >
   > 对策：使用IPV6+NAT穿透（内网主机主动配合NAT路由器建立好与外部映射）

5. RIP路由协议：内部网关协议，其底部使用UDP  (routing information)

6. 路由表：目的网络+距离+下一跳路由器

7. 子网掩码：网络地址+主机地址

8. CIDR（class-less inter-domin routing）无类别域间路由，做法是打破不同类别网络地址间的界限

9. ICMP（Internet control message）= ping 和 tracert 命令

   > 分为查询报文类型和差错报文类型
   >
   > 查询报文类型：8-回送请求；0-回送响应。（ping，命令的使用）
   >
   > 差错报文类型：3-目标不可达；4-原点抑制（网络拥堵的时候主机你不要添乱）；
   >
   > ​							5-重定向消息(路由器有更好的路由信息)
   >
   > ​                            11-超时信息：IP包中有个TTL生存周期字段，每经过一个路由器减1，为0时丢弃，返回超时

   > tarcert命令的作用：
   >
   > ​		发送不同TTL的UDP数据包，路由器每次返回一个ICMP错误代码，就可以获取沿途的所有路由器IP地址，并故意发送一个不可能的端口(>3000)目的主机会返回3-，来表示抵达了目的端。
   >
   > ​		利用分片禁止标志位，来使得路由器丢弃要发送的数据包，随后收到不可达3-和链路MTU。即每次收到ICMP差错报文就减少MTU即可。

10. IGMP（Internet Group Management Protocol）工作在末端路由和组播成员之间，用来加入和退出组播。一般用于UDP协议。

11. TCP可靠性管理

    > 1. 重传机制+滑动窗口+流量控制+拥塞控制
    >
    > 2. 往返延时RTT，超时重传RTO，后者大会导致网络传输效率降低，小则会导致不必要的重传。
    >
    > 3. 重传机制：超时重传+快速重传+SACK（发送包丢包）+D-SACK（确认包丢包）
    >
    > 4. 滑动窗口：提供可靠性和流量控制，它体现了面向字节流的设计思路。
    >
    >    发送窗口（4种状态）：已经发送但是没有收到ACK+还没发送但是收到发送允许；
    >
    >    接收窗口（3种状态）：没有接收但是准备接收
    >
    > 5. 拥塞控制：慢启动+拥塞避免+拥塞发生+快速恢复

12. socket套接字

    > 1. socket作用：连接应用层与传输层；
    > 2. 三次握手发生在connect和accept之间

### 二、运输层

1. TCP：重传计时器+坚持计时器(客户端使用)+保活计时器（2h/75s*10）+时间等待计时器2MSL(客户端使用)；

2. 建立连接定时器+延迟应答定时器+FIN_WAIT_2定时器

3. TCP/IP四层：应用+**运输**+网络层+网络接口层；

   五层：应用+运输+网络+链路+物理层；

   OSI七层协议：应用+表示+会话+**运输层**+网络层+链路层+物理层；

4. 五层：应用（TCP：HTTP+FTP+SMTP//UDP:DHCP//DNS）、运输TCP+UDP、+网络层IP+数据链路（转送帧）+物理层（比特流）

5. [SYN_SEND]+[SYN_RECV]+[ESTABLISHED]

6. TCP trans-ctrl-prot;   UDP user-datagram prot;

7. TCP+UDP 六大区别：连接+可靠+数据+开销+对象+场景（对数可开连场）

8. 链路层网络包最大长度MTU max trans unit46-1500字节。UDP首部8字节。

9. MSS除去首部之后网络包所能容纳的最大TCP数据长度。

10. 沾包

11. 网络层完成主机到主机之间的通信+传输层完成进程到进程之间的通信。

12. https://zhuanlan.zhihu.com/p/133307545

13. 拥塞控制作用于网络：慢开始；

    流量控制：TCP滑动窗口；

14. 传输层TCP【segment】   网络层IP【packet】  数据链路层ARP【frame】  

15. IP中主机号全0表示指定某个网络，主机号为全1表示广播。广播一般无法穿透路由，可以使用D类网络的多播。

16. A类网络的第一位是0；

17. 无分类地址CIDR/x，表示前x位是网络号，剩余的是主机号。

18. TCP包头中包含的内容：**源端口号+目的端口号+序号+确认序列+标志位+校验和+窗口大小**

19. IP 的包头中包含的内容：**版本+首部长度+TTL+协议类别(TCP)+校验和+源IP地址+目的IP地址**

20. MAC包头中包含的内容：**接收方与发送方的MAC地址+协议类型(IP)**

### 三、应用层

1. 常用协议:DHCP(dynamic host configuration)=登录时自动由服务器分配IP与子网掩码。自动+动态+手动分配。

   DHCP服务器端口67，客户端口68。全程使用UDP广播通信。

   > 四个过程：1.客户端广播DHCP发现报文；2.DHCP服务器广播DHCP提供报文；3.客户端选择一个服务器提交DHCP请求报文；4.服务器回应DCHP ACK报文。

   如果客户端和服务器不在一个局域网内，会有路由器作DHCP中继代理。此时中继代理会以单播的形式与DHCP服务器通信。

2. HTTP, URL uniform resource locator统一资源管理定位器，80 443

   2.1 五类状态码

   2.2 优点：简单灵活跨平台；**缺点**：明文无状态不安全；（窃听，截取，篡改，冒充）

   2.3 性能介绍（1.1）：长连接+管道网络传输+队头阻塞

   2.4 改进：    （2.0）：多个请求的头部压缩+二进制格式+不必串行等待+主动推送

   ​                       （3.0）：将下层TCP改成了UDP（QUIC协议类似TCP的可靠传输）

3. HTTPS：加入SSL(secure socket layer)/TLS(transport layer sucurity)层的HTTP，对称密钥传输，非对称密钥的安全验证。

4. 域名解析的工作流程：浏览器缓存+操作系统缓存+hosts+DNS服务器；本地DNS服务器->根DNS服务器->下层DNS

5. 一次URL请求完成的过程：

   > 1.浏览器解析URL-生成HTTP消息委托OS发送
   >
   > 2.DNS域名解析
   >
   > 3.操作系统socket接口+协议栈（TCP+UDP+ICMP+ARP）打包
   >
   > 4.网卡驱动->网卡->交换机->路由器->目的端

6. - （二层）交换机根据MAC地址表查找MAC地址，然后将收到的包发送到相应的端口，交换机起中转的作用。主要工作在数据链路层，不具有MAC地址，基本上是一个桥接功能；
   - （三层）路由器基于IP设计工作在链路层，每个端口都具有MAC和IP地址。路由器只接收MAC地址为自己的包，是则缓存，否则抛弃。然后路由器抛弃MAC包头，根据其后的IP地址使用ARP协议找下一个MAC地址。
   - （三层）交换机：最重要的功能是加快大型局域网络内部的数据的快速转发，如果把大型网络按照部门，地域等等因素划分成一个个小局域网，这将导致大量的网际互访，单纯的使用二层交换机不能实现网际互访；如单纯的使用路由器，由于接口数量有限和路由转发速度慢，将限制网络的速度和网络规模，采用具有路由功能的快速转发的三层交换机就成为首选。

## TCP攻略

1. TCP头部格式：

   > **源端口号+目的端口号+序列号+确认应答号+首部长度+标志位+窗口大小+校验和+数据**

2. 标志位有6个：

   > **URG+ACK+PSH+RST+SYN+FIN**

3. 与UDP之间的区别

   > **连对可开数控**： 连接+对象+可靠+流量控制+开销+数据流
   >
   > **UDP的优势：**网络状况好的情况下，可靠性可以通过应用层保证
   >
   > ​						TCP的复杂度导致难以改进
   >
   > ​						TCP一旦丢包会重传无法保证实时性。

4. 三次握手

   > **SYN报文(SYN+客户端序列号)**
   >
   > **SYN/ACK报文(SYN+ACK+服务端序列号+确认号)**
   >
   > **ACK报文(ACK+确认号)**，此时可以携带数据
   >
   > 
   >
   > 为什么要三次握手？
   >
   > **避免历史连接**:网络拥堵的情况下，客户端发送了多个SYN，如果是收到历史SYN的ACK，第三次握手会范湖RST表示终止这一次连接。
   >
   > **同步双方初始序列号**：（四次握手的简化版）两次握手只能保证客户端的序列号被接收；
   >
   > 避免资源浪费：当客户端在网络拥堵的情况下发送多了SYN时，两次握手会导致开启多个无用的TCP连接 。

   > （1）如果第一次握手中SYN没有收到回应，会超时重传SYN，每次的RTO（retransmission time out）时间翻倍，重传一定次数后终止。
   >
   > （2）如果第二次握手中没有收到SYN+ACK，两边都会超时重传；如果此时客户端继续发送SYN，就会重置服务端的超时定时器以及重传次数。
   >
   > （3）如果第三次握手服务端没有收到ACK，服务器会重传SYN+ACK，达到一定次数后断开连接，而此时客户端连接依然存在；这时如果客户端再给服务端发送数据将得不到回应，超时重传15次后，主动断开。（保活计时器在起作用。）

   > FASTOPEN：TCP快速建立连接：完整的一次需要2.5个RTT(round trip time)，可以在第三次握手中携带数据，就降为2RTT。

   TCP有累计确认机制，当收到多个数据包以后，只需要应答最后一个数据包的ACK报文。

5. 既然IP层可以分片，为什么TCP层还要设置一个MSS来分片呢？

   	如果某个TCP报文没有分片，而是由IP层分片，那么一旦某个IP分片丢失，会导致这个TCP其他分片（因为只有第一个分片中有TCP头部）被重传。也就是说会牵连无辜。所以先双方协商MSS，这个值一般小于MTU，这个时候就不用IP层来分片了。
   	MSS在三次握手时协商，不包含TCP头和option，所以最大为1500-20(TCP header)-20(IP header)=1460.
   	顶层MSS分段好了，可以避免底层分片。但是底层分片将不再具有TCP/UDP/ICMP头部。
   	IP分片到了目的端后由目的端ip层重新组装，对上层TCP和UDP透明。
   	IP包头中有 不允许分片标志+分片标志+分片偏移标志。

6. SYN攻击？

   服务器的SYN队列和accept队列占满的情况。客户端过慢=accept被占满；SYN攻击=SYN队列被占满。

7. TCP四次挥手？

   **由于服务端的ACK和FIN一般是分开发送的，因此需要四次挥手过程。**

   > @客户端发送FIN报文，并进入FIN_WAIT_1状态
   >
   > #服务端发送ACK报文，并进入CLOSED_WAIT状态
   >
   > @客户端收到ACK，并进入FIN_WAIT_2状态
   >
   > #服务端发送FIN，并进入LAST_ACK状态
   >
   > @客户端发送ACK，并进入TIME_WAIT状态
   >
   > #服务端进入CLOSED状态
   >
   > @客户端经过2MSL之后，自动进入CLOSED状态

8. 客户端等待2MSL？（MSL=max segment lifetime）

   **主动发起连接关闭的一方才会有2MSL时间的等待。**

   （1）客户端最后一次发送ACK时，可能服务端没有接收到，此时如果贸然关闭连接，服务器会重发FIN从而在一直等待。如果在此期间内客户端又收到了FIN说明服务端没有收到ACK，2MSL将重新计时。（跟RTO有关）

   （2）确保老的分组在网络中消逝，防止对新连接产生影响

9. TCP中的计时器？

   （1）建立连接计时器（2）重传计时器（3）延迟应答计时器（4）坚持计时器（5）保活计时器

   （6）（FIN_WAIT_2）计时器（7）TIME_WAIT计时器

10. ### TCP的四大法宝：重传机制+滑动窗口+流量控制+拥塞控制：

    > **常见的四种重传机制：**
    >
    > （1）超时重传：RTO应当略大于RTT；
    >
    > （2）快速重传：发送端连续收到三个重复的ACK2后就重传，但是问题是不知道要重传哪一个。
    >
    > （3）SACK方法：(selective ack)在TCP头部选项中将已经缓存情况发送给发送方，就可以只重传丢失部分。
    >
    > （4）duplicate SACK方法

    > **滑动窗口：**
    >
    > 角度：原因+大小+组成

    > **流量控制：**
    >
    > （1）接收端根据剩余窗口的大小，设置可用窗口的大小。
    >
    > （2）如果服务端自行缩减了缓存大小，会出现丢包的现象，为了阻止这种现象发生，TCP规定必须要先收缩窗口才能减少缓存。
    >
    > （3）窗口为0时候的死锁，持续定时器；超时后进行窗口探测；有的可能在探测三次之后RST连接。
    >
    > （4）糊涂窗口综合征：通告小窗口+发送小数据；解决方式：阻止小窗口min(1/2缓存空间，MSS)作为窗口阈值；阻止小数据：nagle算法（对方窗口>MSS||缓存数据>MSS||已经收到ACK）

    > **拥塞控制：**
    >
    > （1）发送方维护的一个反映网络拥塞程度的状态变量；
    >
    > （2）没有在规定时间内收到ACK(超时重传)，就会认为网络发生了拥塞；
    >
    > （3）算法：（congestion window=cwnd拥塞窗口数）
    >
    > ​			慢启动：每收到一个ACK，拥塞窗口就会+1（指数增长）直到达到**慢启动门限**，再改拥塞避免算法；
    >
    > ​							或者说每经过一个传输轮次，拥塞窗口加倍。
    >
    > ​			拥塞避免：每收到一个ACK，拥塞窗口增加1/total(线性增长)直到发生丢包，再启动拥塞发生算法；
    >
    > ​							或者说每经过一个传输轮次，拥塞窗口+1；
    >
    > ​			拥塞发生：a、如发生超时重传时，慢启动门限降为cwnd/2，并令total=1；
    >
    > ​								b、如发生快速重传时，令total和慢启动门限都为cwnd/2；并立马进入c:
    >
    > ​								c、快速恢复算法：令cwnd=腰斩后的拥塞窗口+3，然后在进入拥塞避免状态。

11. TCP半连接队列和全连接队列

    三次握手的时候，在linux内核中维护的两个队列；超过队列限制会直接丢弃或者返回RST；

## socket攻略

1. 监听和真正传输的是两个socket
2. 客户端connect成功是在第二次握手；服务端accept成功之后是在第三次握手

